name: OCV Contrib PR:5.x W10

on:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/OCV-Contrib-PR-5.x-W10.yaml'
  workflow_call:

concurrency:
  group: OCV-Contrib-PR-5.x-W10-${{ github.ref }}
  cancel-in-progress: true

env:
  EXTRA_CMAKE_OPTIONS: '-DCL_Z_OPTION=/Z7 -DOPENCV_DOWNLOAD_PATH=%BINARIES_CACHE% -DBUILD_EXAMPLES=ON -DOPENCV_ENABLE_NONFREE=ON -DCMAKE_BUILD_TYPE=Release'
  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
  PR_AUTHOR_FORK: ${{ github.event.pull_request.head.repo.full_name }}
  SOURCE_BRANCH_NAME: ${{ github.head_ref }}
  TARGET_BRANCH_NAME: ${{ github.base_ref }}
  OPENCV_TEST_DATA_PATH: ${{ github.workspace }}\opencv_extra\testdata
  GTEST_FILTER_STRING: '-Samples.findFile:Drawing.ttf_text:videoio/videocapture_acceleration.read/122:videoio/videocapture_acceleration.read/126'
  DOWNLOAD_DNN_MODELS_FILE: 'download_models.py'

jobs:
  BuildAndTest:
    runs-on: opencv-cn-win
    defaults:
      run:
        shell: cmd
    steps:
    - name: Brief system information
      timeout-minutes: 60
      run: bash %GIT_CACHE%\print_system_information.sh
    - name: Setup infra environment
      timeout-minutes: 60
      if: ${{ github.event.repository.name == 'ci-gha-workflow' }}
      shell: bash
      run: echo "TARGET_BRANCH_NAME=5.x" >> $GITHUB_ENV
    - name: PR info
      timeout-minutes: 60
      run: |
        echo "PR Author: ${{ env.PR_AUTHOR }}"
        echo "PR Author fork: ${{ env.PR_AUTHOR_FORK }}"
        echo "Source branch name: ${{ env.SOURCE_BRANCH_NAME }}"
        echo "Target branch name: ${{ env.TARGET_BRANCH_NAME }}"
    - name: Clean
      timeout-minutes: 60
      run: cd ${{ github.workspace }} && rm -rf *
    - name: Fetch opencv_contrib
      timeout-minutes: 60
      run: cd ${{ github.workspace }} && git clone --branch ${{ env.TARGET_BRANCH_NAME }} --reference %GIT_CACHE%\opencv_contrib.git git@github.com:opencv/opencv_contrib.git
    - name: Merge opencv_contrib with ${{ env.SOURCE_BRANCH_NAME }} branch
      timeout-minutes: 60
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd ${{ github.workspace }}\opencv_contrib
        git pull -v "git@github.com:${{ env.PR_AUTHOR_FORK }}" "${{ env.SOURCE_BRANCH_NAME }}"
    - name: Fetch opencv
      timeout-minutes: 60
      run: cd ${{ github.workspace }} && git clone --branch ${{ env.TARGET_BRANCH_NAME }} --reference %GIT_CACHE%\opencv.git git@github.com:opencv/opencv.git
    - name: Merge opencv with ${{ env.SOURCE_BRANCH_NAME }} branch
      timeout-minutes: 60
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      shell: bash
      run: |
        OPENCV_FORK=$(git ls-remote --heads "git@github.com:/${{ env.PR_AUTHOR }}/opencv" "${{ env.SOURCE_BRANCH_NAME }}") || true
        if [[ ! -z "$OPENCV_FORK" ]]; then
          echo "Merge opencv with ${{ env.SOURCE_BRANCH_NAME }} branch"
          cd opencv
          git pull -v "git@github.com:${{ env.PR_AUTHOR }}/opencv" "${{ env.SOURCE_BRANCH_NAME }}"
        else
          echo "No merge since ${{ env.PR_AUTHOR }}/opencv does not have branch ${{ env.SOURCE_BRANCH_NAME }}"
        fi
    - name: Fetch opencv_extra
      timeout-minutes: 60
      run: cd ${{ github.workspace }} && git clone --single-branch --branch ${{ env.TARGET_BRANCH_NAME }} --reference %GIT_CACHE%\opencv_extra.git git@github.com:opencv/opencv_extra.git
    - name: Merge opencv_extra with ${{ env.SOURCE_BRANCH_NAME }} branch
      timeout-minutes: 60
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      shell: bash
      run: |
        OPENCV_EXTRA_FORK=$(git ls-remote --heads "git@github.com:/${{ env.PR_AUTHOR }}/opencv_extra" "${{ env.SOURCE_BRANCH_NAME }}") || true
        if [[ ! -z "$OPENCV_EXTRA_FORK" ]]; then
          echo "Merge opencv_extra with ${{ env.SOURCE_BRANCH_NAME }} branch"
          cd opencv_extra
          git pull -v "git@github.com:${{ env.PR_AUTHOR }}/opencv_extra" "${{ env.SOURCE_BRANCH_NAME }}"
        else
          echo "No merge since ${{ env.PR_AUTHOR }}/opencv_extra does not have branch ${{ env.SOURCE_BRANCH_NAME }}"
        fi
    - name: Check DNN models update
      timeout-minutes: 60
      shell: bash
      working-directory: ${{ github.workspace }}
      run: |
        LATEST_SAVED_HASH=$(cat $DNN_MODELS\\dnn\\latest-hash-${{ env.TARGET_BRANCH_NAME }}.txt)
        LATEST_HASH=$(sha256sum opencv_extra\\testdata\\dnn\\${{ env.DOWNLOAD_DNN_MODELS_FILE }} | awk '{print $1}')
        if [[ "$LATEST_SAVED_HASH" == "$LATEST_HASH" ]]; then
          echo "MATCHER=true" >> $GITHUB_ENV && MATCHER=true
        fi
        if [[ $MATCHER == 'true' ]]; then
          echo "OPENCV_DNN_TEST_DATA_PATH=$DNN_MODELS" >> $GITHUB_ENV
        else
          echo "OPENCV_DNN_TEST_DATA_PATH=${{ github.workspace }}\\opencv_extra\\testdata" >> $GITHUB_ENV
        fi
    - name: Extra DNN models update
      timeout-minutes: 60
      if: ${{ env.MATCHER != 'true' }}
      run: |
        dir /b /a-d %DNN_MODELS%\\dnn\\|findstr /b ${{ env.DOWNLOAD_DNN_MODELS_FILE }} >excluded.tmp
        xcopy %DNN_MODELS%\\dnn\\* "%OPENCV_DNN_TEST_DATA_PATH%\\dnn\\" /EXCLUDE:excluded.tmp /S /y
        cd %OPENCV_DNN_TEST_DATA_PATH%\\dnn
        python ${{ env.DOWNLOAD_DNN_MODELS_FILE }}
    - name: Configure OpenCV
      timeout-minutes: 60
      run: |
        mkdir ${{ github.workspace }}\build && cd ${{ github.workspace }}\build
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
        cmake -G Ninja ${{ env.EXTRA_CMAKE_OPTIONS }} -DOPENCV_EXTRA_MODULES_PATH=${{ github.workspace }}\opencv_contrib\modules ${{ github.workspace }}\opencv
    - name: Build OpenCV
      timeout-minutes: 60
      id: build-opencv-contrib
      run: |
        cd ${{ github.workspace }}\build
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
        ninja -j %PARALLEL_JOBS% | tee ${{ github.workspace }}\build\build-log.txt
    - name: Warnings check
      timeout-minutes: 60
      run: cd ${{ github.workspace }}\build && python %CI_SCRIPTS%\warnings-handling.py
    - name: Accuracy:3d
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_3d.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:aruco
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_aruco.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:barcode
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_barcode.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:bgsegm
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_bgsegm.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:bioinspired
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_bioinspired.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:calib
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_calib.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:core
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_core.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:dnn
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_dnn.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:dnn_superres
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_dnn_superres.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:face
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_face.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:features2d
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_features2d.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:flann
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_flann.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:fuzzy
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_fuzzy.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:gapi
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_gapi.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:highgui
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_highgui.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:img_hash
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_img_hash.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:imgcodecs
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_imgcodecs.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:imgproc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_imgproc.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:intensity_transform
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_intensity_transform.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:line_descriptor
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_line_descriptor.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:mcc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_mcc.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:ml
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_ml.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:objdetect
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_objdetect.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:optflow
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_optflow.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:phase_unwrapping
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_phase_unwrapping.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:photo
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_photo.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:quality
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_quality.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:rapid
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_rapid.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:reg
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_reg.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:rgbd
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_rgbd.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:saliency
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_saliency.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:shape
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_shape.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:stereo
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_stereo.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:stitching
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_stitching.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:structured_light
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_structured_light.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:superres
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_superres.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:text
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_text.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:tracking
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_tracking.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:video
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_video.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:videoio
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: |
        # batch script is used to run videoio accuracy test iteratively in case of random failures in a parallel run on a self-hosted runner
        cd ${{ github.workspace }}\build && %CI_SCRIPTS%\videoio.bat
    - name: Accuracy:videostab
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_videostab.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:wechat_qrcode
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_wechat_qrcode.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:xfeatures2d
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_xfeatures2d.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:ximgproc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_ximgproc.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:xphoto
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_xphoto.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Accuracy:xstereo
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_test_xstereo.exe --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --test_threads=%PARALLEL_JOBS%
    - name: Performance:3d
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_3d.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:aruco
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_aruco.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:bioinspired
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_bioinspired.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:calib
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_calib.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:core
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_core.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:dnn
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_dnn.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:dnn_superres
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_dnn_superres.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:features2d
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_features2d.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:gapi
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_gapi.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:imgcodecs
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_imgcodecs.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:imgproc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_imgproc.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:line_descriptor
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_line_descriptor.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:objdetect
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_objdetect.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:optflow
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_optflow.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:photo
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_photo.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:reg
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_reg.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:stereo
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_stereo.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:stitching
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_stitching.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:superres
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_superres.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:tracking
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_tracking.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:video
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_video.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:videoio
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_videoio.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:xfeatures2d
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_xfeatures2d.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:ximgproc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_ximgproc.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:xphoto
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_xphoto.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Performance:xstereo
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: cd ${{ github.workspace }}\build && bin\opencv_perf_xstereo.exe --perf_impl=plain --perf_min_samples=1 --perf_force_samples=1 --perf_verify_sanity --skip_unstable=1 --skip_unstable --gtest_filter=${{ env.GTEST_FILTER_STRING }} --perf_threads=%PARALLEL_JOBS%
    - name: Python3
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: |
        cd ${{ github.workspace }}\build
        set PYTHONPATH=%PYTHONPATH%;${{ github.workspace }}\build\python_loader;${{ github.workspace }}\build\lib\python3
        set PATH=%PATH%;${{ github.workspace }}\build\bin;${{ github.workspace }}\build\lib\python3
        python ${{ github.workspace }}\opencv\modules\python\test\test.py --repo ${{ github.workspace }}\opencv -v
    - name: Java
      timeout-minutes: 60
      id: java-test
      if: ${{ always() && steps.build-opencv-contrib.outcome == 'success' }}
      run: |
        cd ${{ github.workspace }}\build
        set PATH=%PATH%;${{ github.workspace }}\build\bin
        ${{ github.workspace }}\opencv\modules\ts\misc\run.py . -a -t java
    - name: Save Unit Test Results
      timeout-minutes: 60
      uses: actions/upload-artifact@v3
      if: ${{ always() && steps.java-test.outcome == 'success' && steps.build-opencv-contrib.outcome == 'success' }}
      with:
        name: junit-html-windows10
        path: ${{ github.workspace }}\build\java_test\testResults\junit-noframes.html
